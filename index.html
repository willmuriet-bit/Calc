<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculatrice ¬∑ PWA</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <style>
    /* RESET & STRUCTURE */
    * {
      box-sizing: border-box;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: black;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      flex-direction: column;
    }

    .calculator {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
    }

    /* √âCRAN */
    .display {
      width: 100%;
      color: white;
      text-align: right;
      font-size: clamp(3rem, 15vw, 5.5rem);
      font-weight: 300;
      padding: 0.3rem 1.2rem 0.2rem 1.2rem;
      white-space: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      direction: ltr;
      scrollbar-width: thin;
      scrollbar-color: #ff9f0a #222;
      line-height: 1.2;
      letter-spacing: 1px;
    }

    .display::-webkit-scrollbar {
      height: 4px;
    }
    .display::-webkit-scrollbar-thumb {
      background: #ff9f0a;
      border-radius: 4px;
    }

    /* GRILLE BOUTONS */
    .buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.7rem;
      width: 100%;
      padding: 0.5rem 0.8rem 1.5rem 0.8rem;
      background: black;
    }

    button {
      width: 100%;
      aspect-ratio: 1 / 1;
      border: none;
      border-radius: 50%;
      font-size: 2rem;
      font-weight: 400;
      cursor: pointer;
      transition: filter 0.1s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      color: white;
      padding: 0;
      box-shadow: none;
      outline: none;
    }

    button span {
      display: block;
      line-height: 1;
    }

    /* Style sp√©cial pour le bouton z√©ro (forme pilule) */
    .btn-zero {
      grid-column: span 2;           /* occupe 2 colonnes */
      aspect-ratio: auto;            /* on enl√®ve le ratio carr√© */
      border-radius: 60px;           /* forme pilule */
      justify-content: flex-start;   /* texte align√© √† gauche */
      padding-left: 1.8rem;          /* marge √† gauche pour le 0 */
    }

    /* Palettes de couleurs */
    .light-gray {
      background: #a5a5a5;
      color: #000;
    }
    .dark-gray {
      background: #333333;
      color: white;
    }
    .orange {
      background: #ff9f0a;
      color: white;
    }

    button:active {
      filter: brightness(1.4);
    }

    /* adaptation tr√®s grands √©crans */
    @media (min-width: 460px) {
      .buttons {
        gap: 0.9rem;
        padding: 0.8rem 1rem 2rem 1rem;
      }
      button {
        font-size: 2.4rem;
      }
      .btn-zero {
        padding-left: 2.2rem;
      }
    }

    /* petit √©cran : r√©duire un peu la police */
    @media (max-width: 340px) {
      button {
        font-size: 1.6rem;
      }
    }

    /* bouton pour installer la PWA */
    .install-btn {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff9f0a;
      color: white;
      border: none;
      border-radius: 30px;
      padding: 0.7rem 1.5rem;
      font-size: 1rem;
      font-weight: 500;
      z-index: 1000;
      box-shadow: 0 4px 10px rgba(255,159,10,0.4);
      cursor: pointer;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    .install-btn:hover {
      opacity: 0.9;
    }
  </style>
</head>
<body>

<div class="calculator">
  <!-- AFFICHEUR PRINCIPAL -->
  <div id="display" class="display">0</div>

  <!-- GRILLE DES TOUCHES -->
  <div class="buttons">
    <!-- ligne 1 : AC, +/-, %, √∑ -->
    <button class="light-gray" onclick="clearAll()"><span>AC</span></button>
    <button class="light-gray" onclick="toggleSign()"><span>+/-</span></button>
    <button class="light-gray" onclick="percentage()"><span>%</span></button>
    <button class="orange" onclick="setOperator('/')"><span>√∑</span></button>

    <!-- ligne 2 : 7,8,9, √ó -->
    <button class="dark-gray" onclick="appendNumber('7')"><span>7</span></button>
    <button class="dark-gray" onclick="appendNumber('8')"><span>8</span></button>
    <button class="dark-gray" onclick="appendNumber('9')"><span>9</span></button>
    <button class="orange" onclick="setOperator('*')"><span>√ó</span></button>

    <!-- ligne 3 : 4,5,6, ‚àí -->
    <button class="dark-gray" onclick="appendNumber('4')"><span>4</span></button>
    <button class="dark-gray" onclick="appendNumber('5')"><span>5</span></button>
    <button class="dark-gray" onclick="appendNumber('6')"><span>6</span></button>
    <button class="orange" onclick="setOperator('-')"><span>‚àí</span></button>

    <!-- ligne 4 : 1,2,3, + -->
    <button class="dark-gray" onclick="appendNumber('1')"><span>1</span></button>
    <button class="dark-gray" onclick="appendNumber('2')"><span>2</span></button>
    <button class="dark-gray" onclick="appendNumber('3')"><span>3</span></button>
    <button class="orange" onclick="setOperator('+')"><span>+</span></button>

    <!-- ligne 5 : 0 (double largeur), ., =  -->
    <!-- Plus de div vide, le bouton 0 occupe 2 colonnes, 
         le point et = prennent 1 colonne chacun, total = 4 colonnes -->
    <button class="dark-gray btn-zero" onclick="appendNumber('0')"><span>0</span></button>
    <button class="dark-gray" onclick="appendNumber('.')"><span>.</span></button>
    <button class="orange" onclick="calculate()"><span>=</span></button>
    <!-- Plus besoin de div vide, la grille est parfaitement √©quilibr√©e -->
  </div>
</div>

<script>
  (function() {
    // ----- √âL√âMENTS DOM -----
    const display = document.getElementById('display');

    // ----- √âTAT DE LA CALCULATRICE -----
    let firstNumber = null;
    let operator = null;
    let waitingForSecondNumber = false;

    // ----- FONCTIONS D'AFFICHAGE -----
    function updateDisplay(value) {
      display.innerText = value;
    }

    // ----- GESTION DES CHIFFRES ET POINT -----
    window.appendNumber = function(number) {
      const currentText = display.innerText;

      if (waitingForSecondNumber) {
        if (number === '.') {
          display.innerText = '0.';
        } else {
          display.innerText = number;
        }
        waitingForSecondNumber = false;
      } else {
        if (number === '.') {
          if (currentText.includes('.')) return;
          display.innerText = currentText + '.';
        } else {
          if (currentText === '0' || currentText === 'Erreur') {
            display.innerText = number;
          } else {
            display.innerText = currentText + number;
          }
        }
      }
    };

    // ----- OP√âRATEURS -----
    window.setOperator = function(op) {
      const currentValue = parseFloat(display.innerText);

      if (operator && waitingForSecondNumber) {
        operator = op;
        return;
      }

      if (firstNumber !== null && operator && !waitingForSecondNumber) {
        let secondNumber = currentValue;
        let result = operate(operator, firstNumber, secondNumber);
        if (result === 'Erreur') display.innerText = 'Erreur';
        else {
          display.innerText = String(result);
          firstNumber = result;
        }
      } else {
        firstNumber = currentValue;
      }

      operator = op;
      waitingForSecondNumber = true;
    };

    // ----- CALCUL EFFECTIF -----
    window.calculate = function() {
      if (!operator || waitingForSecondNumber) {
        return;
      }

      const secondNumber = parseFloat(display.innerText);
      const result = operate(operator, firstNumber, secondNumber);

      if (result === 'Erreur') {
        display.innerText = 'Erreur';
        firstNumber = null;
        operator = null;
        waitingForSecondNumber = false;
        return;
      }

      display.innerText = String(result);
      firstNumber = result;
      operator = null;
      waitingForSecondNumber = true;
    };

    // fonction utilitaire pour les quatre op√©rations
    function operate(op, a, b) {
      switch(op) {
        case '+': return a + b;
        case '-': return a - b;
        case '*': return a * b;
        case '/': 
          if (b === 0) return 'Erreur';
          return a / b;
        default: return b;
      }
    }

    // ----- FONCTIONS SP√âCIALES -----
    window.clearAll = function() {
      display.innerText = '0';
      firstNumber = null;
      operator = null;
      waitingForSecondNumber = false;
    };

    window.toggleSign = function() {
      let val = parseFloat(display.innerText);
      if (isNaN(val)) return;
      val = val * -1;
      display.innerText = String(val);
    };

    window.percentage = function() {
      let val = parseFloat(display.innerText);
      if (isNaN(val)) return;
      val = val / 100;
      display.innerText = String(val);
    };

    // Gestion d'erreur : reset au prochain chiffre
    window.addEventListener('load', function() {
      const originalAppend = window.appendNumber;
      window.appendNumber = function(n) {
        if (display.innerText === 'Erreur') {
          clearAll();
        }
        originalAppend(n);
      };
    });

    // ----- INSTALLATION PWA (beforeinstallprompt) -----
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const installBtn = document.createElement('button');
      installBtn.innerText = 'üì≤ Ajouter √† l‚Äô√©cran';
      installBtn.classList.add('install-btn');
      document.body.appendChild(installBtn);

      installBtn.addEventListener('click', () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('PWA install√©e');
          }
          deferredPrompt = null;
          installBtn.remove();
        });
      });
    });

    window.addEventListener('appinstalled', () => {
      console.log('PWA install√©e, on masque le bouton');
      const btn = document.querySelector('.install-btn');
      if (btn) btn.remove();
    });

    // Correction pour qu'apr√®s "Erreur" on puisse repartir
    const originalClearAll = window.clearAll;
    window.appendNumber = (function(original) {
      return function(n) {
        if (display.innerText === 'Erreur') {
          originalClearAll();
        }
        original(n);
      };
    })(window.appendNumber);

  })();
</script>

</body>
</html>
