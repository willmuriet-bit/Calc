<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculatrice ¬∑ PWA</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <style>
    /* RESET & STRUCTURE - ABSOLUMENT AUCUN D√âFILEMENT */
    * {
      box-sizing: border-box;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      width: 100%;
      background: black;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    /* CONTENEUR PRINCIPAL */
    .app-container {
      position: relative;
      width: 100%;
      max-width: 420px;
      height: 100%;
      max-height: 900px;
      margin: 0 auto;
    }

    /* INTERFACE CALCULATRICE (visible par d√©faut) */
    .calculator {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: black;
      padding: 0;
      z-index: 10;
      transition: opacity 0.3s ease;
    }

    .calculator.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* IMAGE PLEIN √âCRAN (cach√©e par d√©faut) */
    .fullscreen-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 5;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .fullscreen-image.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .fullscreen-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* TEXTE PAR-DESSUS L'IMAGE */
    .image-text {
      position: absolute;
      color: #808080;
      font-size: 12px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      z-index: 6;
      top: 348px;
      left: 287px;
      transform: translate(-50%, -50%);
      white-space: nowrap;
    }

    /* √âCRAN */
    .display-container {
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 0 10px 5px 10px;
      min-height: 0;
      overflow: hidden;
    }
    
    .display {
      width: 100%;
      color: white;
      text-align: right;
      font-size: clamp(4rem, 18vw, 7rem);
      font-weight: 300;
      padding: 0.3rem 0.5rem 0.2rem 0.5rem;
      white-space: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      direction: ltr;
      line-height: 1.2;
      letter-spacing: 2px;
      font-variant-numeric: tabular-nums;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .display::-webkit-scrollbar {
      display: none;
      width: 0;
      height: 0;
    }

    /* GRILLE BOUTONS */
    .buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.7rem;
      width: 100%;
      padding: 0.5rem 0.8rem 1.5rem 0.8rem;
      background: black;
      flex-shrink: 0;
    }

    button {
      width: 100%;
      aspect-ratio: 1 / 1;
      border: none;
      border-radius: 50%;
      font-size: 2rem;
      font-weight: 400;
      cursor: pointer;
      transition: filter 0.1s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      color: white;
      padding: 0;
      box-shadow: none;
      outline: none;
    }

    button span {
      display: block;
      line-height: 1;
    }

    .btn-zero {
      grid-column: span 2;
      aspect-ratio: auto;
      border-radius: 60px;
      justify-content: flex-start;
      padding-left: 1.8rem;
    }

    .light-gray {
      background: #a5a5a5;
      color: #000;
    }
    .dark-gray {
      background: #333333;
      color: white;
    }
    .orange {
      background: #ff9f0a;
      color: white;
    }

    button:active {
      filter: brightness(1.4);
    }

    @media (min-width: 460px) {
      .buttons {
        gap: 0.9rem;
        padding: 0.8rem 1rem 2rem 1rem;
      }
      button {
        font-size: 2.4rem;
      }
      .btn-zero {
        padding-left: 2.2rem;
      }
      .image-text {
        top: 348px;
        left: 287px;
      }
    }

    @media (max-width: 340px) {
      button {
        font-size: 1.6rem;
      }
      .display {
        font-size: clamp(3.2rem, 15vw, 5rem);
      }
      .image-text {
        font-size: 10px;
        top: 300px;
        left: 240px;
      }
    }

    /* bouton pour installer la PWA */
    .install-btn {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff9f0a;
      color: white;
      border: none;
      border-radius: 30px;
      padding: 0.7rem 1.5rem;
      font-size: 1rem;
      font-weight: 500;
      z-index: 1000;
      box-shadow: 0 4px 10px rgba(255,159,10,0.4);
      cursor: pointer;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    .install-btn:hover {
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- INTERFACE CALCULATRICE -->
    <div class="calculator" id="calculator">
      <!-- AFFICHEUR -->
      <div class="display-container">
        <div id="display" class="display">0</div>
      </div>

      <!-- BOUTONS -->
      <div class="buttons">
        <!-- ligne 1 : AC/C, +/-, %, √∑ -->
        <button class="light-gray" id="acButton" onclick="handleACorC()"><span>AC</span></button>
        <button class="light-gray" id="toggleSignButton" onclick="handleToggleSign()" onmousedown="startLongPress()" onmouseup="cancelLongPress()" onmouseleave="cancelLongPress()" ontouchstart="startLongPress()" ontouchend="cancelLongPress()" ontouchcancel="cancelLongPress()"><span>+/-</span></button>
        <button class="light-gray" id="percentButton" onclick="handlePercent()"><span>%</span></button>
        <button class="orange" onclick="setOperator('/')"><span>√∑</span></button>

        <!-- ligne 2 : 7,8,9, √ó -->
        <button class="dark-gray" onclick="appendNumber('7')"><span>7</span></button>
        <button class="dark-gray" onclick="appendNumber('8')"><span>8</span></button>
        <button class="dark-gray" onclick="appendNumber('9')"><span>9</span></button>
        <button class="orange" onclick="setOperator('*')"><span>√ó</span></button>

        <!-- ligne 3 : 4,5,6, ‚àí -->
        <button class="dark-gray" onclick="appendNumber('4')"><span>4</span></button>
        <button class="dark-gray" onclick="appendNumber('5')"><span>5</span></button>
        <button class="dark-gray" onclick="appendNumber('6')"><span>6</span></button>
        <button class="orange" onclick="setOperator('-')"><span>‚àí</span></button>

        <!-- ligne 4 : 1,2,3, + -->
        <button class="dark-gray" onclick="appendNumber('1')"><span>1</span></button>
        <button class="dark-gray" onclick="appendNumber('2')"><span>2</span></button>
        <button class="dark-gray" onclick="appendNumber('3')"><span>3</span></button>
        <button class="orange" onclick="setOperator('+')"><span>+</span></button>

        <!-- ligne 5 : 0, ., = -->
        <button class="dark-gray btn-zero" onclick="appendNumber('0')"><span>0</span></button>
        <button class="dark-gray" id="dotButton" onclick="handleDotClick()"><span>.</span></button>
        <button class="orange" onclick="calculate()"><span>=</span></button>
      </div>
    </div>

    <!-- IMAGE PLEIN √âCRAN (avec texte par-dessus) -->
    <div class="fullscreen-image" id="fullscreenImage">
      <img src="capture.jpg" alt="Capture">
      <div class="image-text" id="imageText">ligne/across/page - P</div>
    </div>
  </div>

<script>
  (function() {
    // ----- √âL√âMENTS DOM -----
    const display = document.getElementById('display');
    const acButton = document.getElementById('acButton');
    const toggleSignButton = document.getElementById('toggleSignButton');
    const percentButton = document.getElementById('percentButton');
    const dotButton = document.getElementById('dotButton');
    const calculator = document.getElementById('calculator');
    const fullscreenImage = document.getElementById('fullscreenImage');
    const imageText = document.getElementById('imageText');
    
    // ----- CONSTANTES -----
    const MAX_DIGITS = 8;
    const API_URL = 'https://pi-revelations-3a64f-default-rtdb.europe-west1.firebasedatabase.app/code/.json';
    const LONG_PRESS_DURATION = 1000;

    // ----- VARIABLE P (stocke le premier nombre √† 4 chiffres tap√©) -----
    let P = null;
    
    // ----- DONN√âES API -----
    let apiData = null;
    
    // ----- CYCLE DU % -----
    let percentCycle = 0;
    
    // ----- MODE SP√âCIAL -----
    let secretMode = true;
    
    // ----- √âTAT -----
    let firstNumber = null;
    let operator = null;
    let waitingForSecondNumber = false;
    let isTyping = false;
    let currentNumberProcessed = false;
    
    // ----- TIMER POUR L'APPUI LONG -----
    let longPressTimer = null;
    
    // ----- VARIABLES POUR LES 3 APPUIS SUR "." -----
    let dotClickCount = 0;
    let dotClickTimer = null;

    // ----- FONCTION POUR METTRE √Ä JOUR LE TEXTE DE L'IMAGE -----
    function updateImageText() {
      if (apiData && P) {
        imageText.textContent = `${apiData.line}/${apiData.across}/${apiData.page} - ${P}`;
      } else if (apiData) {
        imageText.textContent = `${apiData.line}/${apiData.across}/${apiData.page} - ?`;
      } else if (P) {
        imageText.textContent = `?/?/? - ${P}`;
      } else {
        imageText.textContent = "?/?/? - ?";
      }
    }

    // ----- FONCTION POUR AFFICHER L'IMAGE -----
    function showImage() {
      updateImageText();
      calculator.classList.add('hidden');
      fullscreenImage.classList.add('visible');
    }

    // ----- FONCTION POUR CACHER L'IMAGE -----
    function hideImage() {
      calculator.classList.remove('hidden');
      fullscreenImage.classList.remove('visible');
    }

    // ----- GESTIONNAIRE POUR LE BOUTON "." (3 appuis) -----
    window.handleDotClick = function() {
      dotClickCount++;
      
      if (dotClickTimer) {
        clearTimeout(dotClickTimer);
      }
      
      dotClickTimer = setTimeout(() => {
        dotClickCount = 0;
        dotClickTimer = null;
      }, 1000);
      
      if (dotClickCount === 3) {
        showImage();
        dotClickCount = 0;
        clearTimeout(dotClickTimer);
        dotClickTimer = null;
        return; // Ne pas ajouter de point
      }
      
      // Sinon, comportement normal du point
      performAppendDot();
    };

    // ----- FONCTION NORMALE POUR AJOUTER UN POINT -----
    function performAppendDot() {
      let currentText = display.innerText;
      
      if (currentText === 'Erreur' || currentText === 'Chargement...') {
        display.innerText = '0';
        currentText = '0';
        firstNumber = null;
        operator = null;
        waitingForSecondNumber = false;
      }

      if (waitingForSecondNumber) {
        display.innerText = '0.';
        waitingForSecondNumber = false;
        resetPercentCycle();
        isTyping = true;
        currentNumberProcessed = false;
      } else {
        if (currentText.includes('.')) return;
        display.innerText = currentText + '.';
        isTyping = true;
        currentNumberProcessed = false;
      }
      
      updateACButton();
    }

    // ----- FONCTION POUR D√âMARRER L'APPUI LONG -----
    window.startLongPress = function() {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
      }
      
      longPressTimer = setTimeout(() => {
        secretMode = false;
        percentCycle = 0;
        console.log("Mode secret d√©sactiv√© (appui long)");
        
        percentButton.style.filter = 'brightness(1.5)';
        setTimeout(() => {
          percentButton.style.filter = '';
        }, 200);
        
        longPressTimer = null;
      }, LONG_PRESS_DURATION);
    };

    // ----- FONCTION POUR ANNULER L'APPUI LONG -----
    window.cancelLongPress = function() {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
    };

    // ----- FONCTION POUR EXTRAIRE LES 4 CHIFFRES SANS VIRGULE -----
    function extractFourDigits(numberStr) {
      return numberStr.replace('.', '');
    }

    // ----- FONCTION POUR V√âRIFIER SI UN NOMBRE A 4 CHIFFRES OU PLUS -----
    function hasFourOrMoreDigits(numberStr) {
      const digitsOnly = numberStr.replace('-', '').replace('.', '');
      return digitsOnly.length >= 4;
    }

    // ----- FONCTION POUR V√âRIFIER SI UN NOMBRE A EXACTEMENT 4 CHIFFRES -----
    function hasExactlyFourDigits(numberStr) {
      const digitsOnly = numberStr.replace('-', '').replace('.', '');
      return digitsOnly.length === 4;
    }

    // ----- FONCTION POUR VALIDER ET STOCKER P -----
    function validateAndStoreFourDigitNumber() {
      const currentText = display.innerText;
      
      // Ignorer les r√©sultats du cycle %
      if (currentText.includes('.') && currentText.length > 5 && currentText !== '0.') return;
      
      // Ne pas stocker si on n'est pas en train de taper
      if (!isTyping) return;
      
      // Ne pas stocker si d√©j√† trait√©
      if (currentNumberProcessed) return;
      
      if (hasExactlyFourDigits(currentText)) {
        const fourDigits = extractFourDigits(currentText);
        
        if (P === null) {
          P = fourDigits;
          console.log("P valid√© et stock√© :", P);
          fetchApiData(P);
          currentNumberProcessed = true;
          updateImageText();
        }
      }
    }

    // ----- FONCTION POUR APPELER L'API -----
    async function fetchApiData(code) {
      try {
        const response = await fetch(API_URL);
        const data = await response.json();
        
        if (data[code]) {
          apiData = data[code];
          console.log("Donn√©es API pour", code, ":", apiData);
          updateImageText();
        } else {
          console.log("Code non trouv√©:", code);
          apiData = null;
        }
      } catch (error) {
        console.error("Erreur API:", error);
        apiData = null;
      }
    }

    // ----- FONCTION POUR LE BOUTON % -----
    window.handlePercent = function() {
      if (!secretMode) {
        performNormalPercentage();
        return;
      }
      performSecretPercent();
    };

    // ----- POURCENTAGE NORMAL -----
    function performNormalPercentage() {
      if (display.innerText === 'Erreur' || display.innerText === 'Chargement...') return;
      let val = parseFloat(display.innerText);
      if (isNaN(val)) return;
      val = val / 100;
      display.innerText = formatDisplay(val);
      updateACButton();
    }

    // ----- MODE SECRET (cycle) -----
    function performSecretPercent() {
      setTimeout(() => {
        acButton.innerHTML = '<span>AC</span>';
      }, 0);
      
      if (P === null) {
        display.innerText = "0";
        updateACButton();
        return;
      }
      
      if (apiData === null) {
        display.innerText = "Chargement...";
        updateACButton();
        return;
      }
      
      switch(percentCycle) {
        case 0:
          display.innerText = P;
          percentCycle = 1;
          break;
        case 1:
          display.innerText = `${apiData.line}.${apiData.across}.${apiData.page}`;
          percentCycle = 2;
          break;
        case 2:
          display.innerText = `${apiData.line}${apiData.across}${apiData.page}`;
          percentCycle = 0;
          break;
      }
      
      isTyping = false;
      updateACButton();
    }

    // ----- FONCTION POUR R√âINITIALISER LE CYCLE % -----
    function resetPercentCycle() {
      percentCycle = 0;
    }

    // ----- FONCTION POUR METTRE √Ä JOUR LE BOUTON AC/C -----
    function updateACButton() {
      if (!acButton) return;
      
      const currentText = display.innerText;
      
      if (currentText === '0' || 
          currentText === 'Erreur' || 
          currentText === 'Chargement...' ||
          (waitingForSecondNumber && currentText === '0')) {
        acButton.innerHTML = '<span>AC</span>';
      } else {
        acButton.innerHTML = '<span>C</span>';
      }
    }

    // ----- AC/C -----
    window.handleACorC = function() {
      const currentText = display.innerText;
      const buttonText = acButton.innerText;
      
      if (buttonText === 'AC') {
        display.innerText = '0';
        firstNumber = null;
        operator = null;
        waitingForSecondNumber = false;
        isTyping = false;
        currentNumberProcessed = false;
        resetPercentCycle();
        hideImage();
      } else {
        if (currentText === 'Erreur' || currentText === 'Chargement...') {
          display.innerText = '0';
          isTyping = false;
          currentNumberProcessed = false;
        } 
        else if (currentText.length === 1) {
          display.innerText = '0';
          isTyping = false;
          currentNumberProcessed = false;
        }
        else if (currentText.length === 2 && currentText.startsWith('-')) {
          display.innerText = '0';
          isTyping = false;
          currentNumberProcessed = false;
        }
        else {
          display.innerText = currentText.slice(0, -1);
          isTyping = true;
          currentNumberProcessed = false;
        }
      }
      
      updateACButton();
    };

    // ----- AJOUTER UN CHIFFRE -----
    window.appendNumber = function(number) {
      let currentText = display.innerText;
      
      if (currentText === 'Erreur' || currentText === 'Chargement...') {
        display.innerText = '0';
        currentText = '0';
        firstNumber = null;
        operator = null;
        waitingForSecondNumber = false;
      }

      if (waitingForSecondNumber) {
        // Nouveau nombre apr√®s op√©rateur
        if (number === '.') {
          display.innerText = '0.';
        } else {
          display.innerText = number;
        }
        waitingForSecondNumber = false;
        resetPercentCycle();
        isTyping = true;
        currentNumberProcessed = false; // ‚Üê Important: nouveau nombre, pas encore trait√©
      } else {
        // On continue de taper le m√™me nombre
        let newText = currentText;
        
        if (number === '.') {
          if (currentText.includes('.')) return;
          newText = currentText + '.';
        } else {
          if (currentText === '0') {
            newText = number;
          } else {
            newText = currentText + number;
          }
        }
        
        if (countDigits(newText) <= MAX_DIGITS) {
          display.innerText = newText;
          isTyping = true;
          currentNumberProcessed = false; // Le nombre a chang√©, donc plus trait√©
        }
      }
      
      updateACButton();
    };

    // ----- OP√âRATEURS (CORRIG√â) -----
    window.setOperator = function(op) {
      // 1. D'ABORD valider et stocker le nombre tap√©
      validateAndStoreFourDigitNumber();

      if (operator && waitingForSecondNumber) {
        // Changer d'op√©rateur sans calcul
        operator = op;
        updateACButton();
        return;
      }

      if (firstNumber !== null && operator && !waitingForSecondNumber) {
        // Effectuer le calcul pr√©c√©dent
        let secondNumber = parseFloat(display.innerText);
        let result = operate(operator, firstNumber, secondNumber);
        if (result === 'Erreur') {
          display.innerText = 'Erreur';
          firstNumber = null;
          operator = null;
          waitingForSecondNumber = false;
          isTyping = false;
          currentNumberProcessed = false;
          updateACButton();
          return;
        } else {
          const formattedResult = formatDisplay(result);
          display.innerText = formattedResult;
          firstNumber = parseFloat(formattedResult);
          isTyping = false;
          currentNumberProcessed = false;
        }
      } else {
        // Premier op√©rateur apr√®s un nombre
        firstNumber = parseFloat(display.innerText);
        // ‚úÖ On garde isTyping = true (on a fini de taper ce nombre)
        // isTyping reste true
      }

      // Pr√©parer la saisie du deuxi√®me nombre
      operator = op;
      waitingForSecondNumber = true;
      display.innerText = '0';
      resetPercentCycle();
      updateACButton();
      
      // ‚úÖ R√©initialiser pour le prochain nombre
      currentNumberProcessed = false;
    };

    // ----- CALCUL -----
    window.calculate = function() {
      if (!operator || waitingForSecondNumber) return;

      const secondNumber = parseFloat(display.innerText);
      
      // Division secr√®te
      if (secretMode && operator === '/' && P !== null && apiData !== null) {
        if (hasFourOrMoreDigits(display.innerText)) {
          const acrossStr = apiData.across.toString().padStart(2, '0');
          const result = `${apiData.line}.${acrossStr}${apiData.page}`;
          display.innerText = result;
          
          firstNumber = null;
          operator = null;
          waitingForSecondNumber = true;
          isTyping = false;
          currentNumberProcessed = false;
          resetPercentCycle();
          
          setTimeout(() => {
            acButton.innerHTML = '<span>AC</span>';
          }, 0);
          
          updateACButton();
          return;
        }
      }
      
      // Calcul normal
      const result = operate(operator, firstNumber, secondNumber);

      if (result === 'Erreur') {
        display.innerText = 'Erreur';
        firstNumber = null;
        operator = null;
        waitingForSecondNumber = false;
        isTyping = false;
        currentNumberProcessed = false;
        updateACButton();
        return;
      }

      display.innerText = formatDisplay(result);
      firstNumber = parseFloat(display.innerText);
      operator = null;
      waitingForSecondNumber = true;
      
      isTyping = false;
      currentNumberProcessed = false;
      resetPercentCycle();
      
      setTimeout(() => {
        acButton.innerHTML = '<span>AC</span>';
      }, 0);
      
      updateACButton();
    };

    // ----- OP√âRATIONS -----
    function operate(op, a, b) {
      switch(op) {
        case '+': return a + b;
        case '-': return a - b;
        case '*': return a * b;
        case '/': 
          if (b === 0) return 'Erreur';
          return a / b;
        default: return b;
      }
    }

    // ----- TOGGLE SIGN -----
    window.toggleSign = function() {
      if (display.innerText === 'Erreur' || display.innerText === 'Chargement...') return;
      let val = parseFloat(display.innerText);
      if (isNaN(val)) return;
      val = val * -1;
      display.innerText = formatDisplay(val);
      
      currentNumberProcessed = false;
      resetPercentCycle();
      updateACButton();
    };

    // ----- FONCTIONS UTILITAIRES -----
    function countDigits(str) {
      const withoutSign = str.replace('-', '');
      const digitsOnly = withoutSign.replace('.', '');
      return digitsOnly.length;
    }

    function formatDisplay(value) {
      let str = String(value);
      if (str === 'Erreur') return 'Erreur';
      
      const digitCount = countDigits(str);
      if (digitCount <= MAX_DIGITS) return str;
      
      if (str.includes('.')) {
        const parts = str.split('.');
        const integerPart = parts[0].replace('-', '');
        const sign = str.startsWith('-') ? '-' : '';
        
        if (integerPart.length >= MAX_DIGITS) {
          return sign + integerPart.substring(0, MAX_DIGITS);
        } else {
          const maxDecimals = MAX_DIGITS - integerPart.length;
          const decimalPart = parts[1].substring(0, maxDecimals);
          return sign + integerPart + '.' + decimalPart;
        }
      } else {
        const sign = str.startsWith('-') ? '-' : '';
        const absStr = str.replace('-', '');
        return sign + absStr.substring(0, MAX_DIGITS);
      }
    }

    // ----- INITIALISATION -----
    setTimeout(() => updateACButton(), 0);

    // ----- PWA -----
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const installBtn = document.createElement('button');
      installBtn.innerText = 'üì≤ Ajouter √† l‚Äô√©cran';
      installBtn.classList.add('install-btn');
      document.body.appendChild(installBtn);

      installBtn.addEventListener('click', () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(() => {
          deferredPrompt = null;
          installBtn.remove();
        });
      });
    });

    window.addEventListener('appinstalled', () => {
      const btn = document.querySelector('.install-btn');
      if (btn) btn.remove();
    });

  })();
</script>

</body>
</html>
